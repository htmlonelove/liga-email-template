<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>

  <link rel="stylesheet"
        href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/atom-one-dark-reasonable.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      font-size: 20px;
      line-height: 30px;
    }

    h1,
    h2 {
      margin: 0;
    }

    h1 {
      margin-top: 50px;
      margin-bottom: 50px;
    }

    h2 {
      margin-top: 55px;
      margin-bottom: 10px;
    }

    .author {
      margin: 50px 0;
    }

    .author address {
      display: flex;
      flex-direction: column;
    }

    .author p {
      font-weight: 600;
    }

    a {
      text-decoration: none;
      opacity: 1;
      transition: color 0.3s;
      color: #2c39f2;
    }

    a:hover {
      color: #ff1553;
    }

    ul {
      list-style: none;
      padding: 0;
      margin-left: 20px;
    }

    li {
      margin-bottom: 20px;
      position: relative;
      padding-left: 15px;
    }

    li::before {
      content: "";
      position: absolute;
      top: 14px;
      left: 0;
      width: 5px;
      height: 5px;
      background-color: #2c39f2;
      border-radius: 50%;
      opacity: 1;
    }

    pre {
      display: flex;
    }

    code {
      width: 100%;
    }
  </style>
</head>
<body>

<div style="max-width: 800px; width: 100%; margin: 0 auto;">
  <h1>Основы верстки  писем</h1>

  <h2>Содержание</h2>
  <ul>
    <li><a href="#intro">Введение</a></li>
    <li><a href="#tools">Инструменты</a></li>
    <li><a href="#specific">Специфика табличной верстки писем</a></li>
    <li><a href="#outlook">Проблемы в аутлуке</a></li>
    <li><a href="#practice">Обзор сборки</a></li>
    <li><a href="#links">Полезные ссылки</a></li>
  </ul>

  <section id="intro">
    <h2>Введение</h2>
    <p>Верстка писем задача кропотливая, требует много времени, и сильно отличается от привычной нам. Это вообще отдельная квалификация, есть множество компаний, которые занимаются имейл-маркетингом.
       Почему так, макеты же обычно довольно простые, на пару часов работы? Ответ – почтовые клиенты (далее в статье просто «клиенты»), зоопарк которых, как в том анекдоте «одной ногой стоит в светлом будущем, другой в мрачном прошлом», а поддерживать надо все, и поэтому мы привязаны к табличной верстке, которая работает везде. Ярким примером устарелости и проблемности является аутлук, хотя как корпоративной безопасности может угрожать border-radius я не представляю.
    </p>
    <p>
      Что же представляет собой табличная верстка? У нас только три тега для формирования сетки – table, tr, td, никаких div (ну почти никаких, но об этом в обзоре сборки). И свойство display для этих тегов без нужды я не советую менять. Если все же необходимость есть, то ограничьтесь block/inline-block/inline, никаких flex.
    </p>
    <p>Работать можно в одном-единственном html файле, который и отдадим потом заказчику. У нас нет отдельных css и js файлов, скриптов в почте нет вообще, а весь css содержится инлайново и в style в head. В письме может даже не быть картинок. </p>
    <p>
      В табличной верстке один div заменяется конструкцией table>tr>td, tr>td или просто td, по обстоятельствам, как следствие верстка очень разрастается и возникает большая и однообразная вложенность, например вот такая, это ссылка из трехколоночного футера, <span style="word-break: break-all;">table>tbody>tr>td>table>tbody>tr>td>table>tbody>tr>td>table>tbody>tr>td>table>tbody>tr>td>table>tbody>tr>td>a</span>. Представьте что вы верстаете в excel, только вместо ячеек - td, несколько ячеек в строке оборачиваются tr, а вместо объединенных ячеек - table.
    </p>
    <p>
      Приведу пару примеров:<br>
      Вот так выглядит сетка для случая, если у вас на первой строке текст во всю длину, а на второй две картинки
    </p>
      <pre>
        <code>
      table
        tr
          td
            p текст
        tr
          td
            table
              tr
                td
                  img
                td
                  img
        </code>
      </pre>
    <p>
      А вот тут на скрине строка из списка покупок, синим обозначены таблицы, зеленым - ячейки<br>
      <img src="https://i.gyazo.com/bedc0dbcff1f73d081e133ab79cbb7a9.png" alt="Пример таблицы" width="600">
    </p>

  </section>

  <section id="tools">
    <h2>Инструменты</h2>
    <ul>
      <li>Редактор, любой, задача в архитектурном плане плевая, и сборка не требуется, можно верстать сразу итоговое письмо. Однако я подготовил
        <a href="#practice">сборку с pug</a>, возможно кому-то это упростит работу.</li>
      <li>Mozilla thunderbird для отправки писем. Есть и онлайн инструменты, например вот этот <a href="https://putsmail.com/tests/new">https://putsmail.com/tests/new</a> . "Обычные" клиенты типа gmail нам не подойдут, так как они не умеют вставлять html разметку в письмо. то есть вставить то можно, но получателю придет разметка в виде Plaintext, и ренедериться письмо не будет</li>
      <li>Outlook последней версии, и если есть возможность, поставьте несколько предыдущих версий. Аутулк – это боль, хотя нет,
        <a href="#outlook"><strong style="text-transform: uppercase;">БОООООЛЬ</strong></a>. Именно он увеличивает время на разработку в 3 и более раз.
      </li>
      <li>Иные доступные вам почтовые клиенты.</li>
    </ul>
  </section>

  <section id="specific">
    <h2>Специфика табличной верстки писем</h2>
    <p>Помимо использования таблиц для формирования сетки, у верстки писем есть еще целый список особенностей, которые можно озаглавить "Welcome to the stoneage!":</p>
    <ul>
      <li>
        Сетка должна быть надежна и «красива» как кирпич, то есть очень примитивна. Для верстки мы используем таблицы и инлайновые стили. Можете использовать и классы, не забудьте прогнать письмо через инлайнер https://templates.mailchimp.com/resources/inline-css/ (также реализовано в <a href="#practice">сборке</a>). Тег style в head использовать можно, но он может резаться клиентами. И клиенты это не современные браузеры, которые компенсируют какие-то ваши ошибки, нееет, клиенты вам всё покажут и поломают. Также инлайновые стили означают что то, что нельзя записать инлайн (медиаправила, ховеры, псевдоэлементы), может отвалиться вместе со style в head.
      </li>
      <li>
        Используем CSS2, а не CSS3. Можно пользоваться устаревшими атрибутами (width, align, valign, bgcolor  и пр.), я бы даже советовал их использовать, это дает некоторую визуальную структуризацию, совместимость, и длиннющие инлайновые style сложно читать.
      </li>
      <li>
        Придерживаемся тегов HTML1. Не пугайтесь, вам хватит очень скромного списка из h1-h6, p, span, div, a, img (без picture).
      </li>
      <li>
        Скриптов нет, и я думаю никогда и не будет по причине безопасности.
      </li>
      <li>
        Видео нет. Вставляйте картинкой с ссылкой.
      </li>
      <li>
        SVG, WEBP нет. Только JPG и PNG. Тег picture и srcset тоже не используем, только img и только один вариант картинки.
      </li>
      <li>
        Табличные атрибуты типа Colspan и Rowspan используем с осторожностью, в аутулке бывают проблемы.
      </li>
      <li>
        Пробелы имеют значение - "висящие" пробелы между тегами часто создают всякие баги - пустые строки, сломанную сетку. Править можно с помощью установки значений font-size, line-height в 0 у table, tr, td.
      </li>
      <li>
        Margin мы всегда сбрасываем для табличных тегов и никогда им его не указываем, поддержка плохая, пользуемся только padding, который тоже предварительно сбрасываем. Однако центровка работает, и для самого тега table можно указывать margin: 0 auto. Если вам нужен и margin и padding, то надо будет делать блок таблицей, у ее ячейки указывайте нужный padding, и вкладывать ее в обертку (td) с padding, который будет играть роль margin. А вот для остальных тегов (заголовков, текстов и прочего) – да, использовать можно, но я предпочитаю пользоваться только паддингом + обертки с паддингом. Железобетонная верстка получается, хоть бы и код не красивый.
      </li>
      <li>
        Контент внутри ячеек оборачиваем в нужные теги. "Голого" текста быть не должно.
      </li>
      <li>
        На тег style в head не надеемся, он может резаться клиентами, и не забывайте про необходимость !important в нем чтобы перебить инлайновые стили. Про хитрость для адаптива в случае удаления style в разделе <a href="#practice">сборки</a> можно прочитать, сетка футера сделана как раз для такого случая.
      </li>
      <li>
        Шрифты подключаем с помощью всех известных способов одновременно - link, @import, @font-face. Поддержка шрифтов <a href="https://www.campaignmonitor.com/css/text-fonts">печальна</a>, так что предупредите заказчика, что в большинстве клиентов будет Arial рендериться. Клиенты вообще очень не любят внешние файлы качать, кроме картинок.
      </li>
      <li>
        Outlook многое не умеет, или криво рендерит, поэтому вам пригодится вот такая условная конструкция
        <pre>
          <code>
&lt;!--[if mso]&gt;
  &lt;td style="padding:0;margin:0"&gt;
    Тут верстка только для аутлука
  &lt;/td&gt;
&lt;![endif]--&gt;
  &lt;td style="mso-hide: all"&gt;
    А это для остальных клиентов, mso-hide: all спрячет блок для аутлука.
  &lt;/td&gt;
          </code>
        </pre>
        Я постоянно применяю ее для картинок, обычные для аутлука, и ретинизированные для остальных.<br>
        Есть и иные <a href="https://stackoverflow.design/email/base/mso/">условия</a>, но нужды в них ни разу не возникало. В условия оборачиваются как минимум ячейки td, а не их содержимое!
      </li>
      <li>
        Рекомендую для всех таблиц минимум такие стили &lt;table style="border-collapse: collapse;mso-table-lspace:0pt;mso-table-rspace:0pt;" role="presentation"> , дополнять своими можно, также хорошо дополнить width="100%" cellspacing="0" cellpadding="0" border="0", это атрибуты таблицы, а role="presentation" служит для того, чтобы скринридер не выделял таблицу. Также советую прописывать table-layout: fixed где это возможно.
      </li>
      <li>
        Использовать ретинизированные картинки можно, но скалируйте их до нужного размера с помощью атрибутов и стилей. Аутулк не умеет скалировать, пользуйтесь условиями.
      </li>
      <li>
        Закругленные уголки. Аутлук border-radius не поддерживает, и кнопки с круглыми уголками в нем придется делать с помощью <a href="https://www.litmus.com/blog/a-guide-to-bulletproof-buttons-in-email-design">Conditional-padding, или VML-based</a>. А вот если вам надо сделать не просто кнопку, а целую таблицу с круглыми уголками, то предложите заказчику отказаться от них в аутлуке, так как это нормально не сделать, методы применяемые для кнопок тут слабо подходят, либо не подходят вообще, и вызовет много проблем при внедрении.
        Есть еще один вариант, совершенно жуткий. но железно работающий - https://gyazo.com/625f3d5de183ac772a3ea710b4cadd89 это сильно увеличенная картинка с border-radius 8 px, видите все эти квадратики разного оттенка, в количестве 49 штук? Это отдельные ячейки.
      </li>
      <li>
        Для символа рубля, иных валют, и всяких спецсимволов не надо заморачиваться со шрифтами, как я уже говорил, поддержка кастомных шрифтов слабая, используйте простой юникод - &#8381;
      </li>
      <li>
        rgba и opacity плохо поддерживается, подбирайте похожие цвета без прозрачности, в этом вам может помочь плагин для браузера типа пипетки.
      </li>
      <li>
        Аутлук не выстраивает inline блоки горизонтально внутри td, а распологает их вертикально. Для горизонтального расположения нам понадобится дополнительная таблица (см. пример в footer в сборке).
      </li>
      <li>
        Всем ссылкам добавляйте target="_blank"
      </li>
      <li>
        Фоновые картинки сложны в использовании. Рассмотрите вариант вставки всего блока просто картинкой, вместе с надписями. Особенно если это что-то эдакое<br>
        <img src="https://i.gyazo.com/894fdf2f4106cf0a36b0768b33a95b2d.png" alt="" width="400">
      </li>
    </ul>
  </section>

  <section id="outlook">
    <h2>Об аутлуке</h2>
    <p>Семейство outlook использует свой собственный движок для рендера писем, поэтому список поддерживаемых css-свойств много меньше чем в браузерах и других почтовых клиентах -
      <a href="https://www.caniemail.com/clients/">https://www.caniemail.com/clients/</a> , и поддерживает язык разметки
      <a href="https://www.w3.org/TR/NOTE-VML">Vector Markup Language (VML)</a>. Большим минусом VML является необходимость указывать точные размеры блока. Проблемы аутлука связаны не только со слабой поддержкой css, но и специфичном взгляде на сетку и в свойственных только ему багах. Если при верстке вы будете учитывать мои советы из секции <a href="#specific">"Специфика табличной верстки писем"</a> вы избавите себя от большинства проблем. У gmail тоже поддержка css слаба, но по своему опыту скажу, что mail.ru, yandex, как и gmail, проблем не доставляют.
    </p>
    <p>
      В аутлуке есть два очень неприятных, но редких, бага, Microsoft их признает, но не чинит. Первый - светлая/темная точка в один пиксель, появляется на одном из углов таблиц/ячеек. Второй – светлая/темная линия, появляется на границе таблицы/ячейки. Единственный вариант починки – удаление большого куска разметки и написание заново, с отличной от первоначальной разметки. Причины багов неизвестны, возникают рандомно от пользователя к пользователю. То есть у вас он может быть, а у клиента нет, и наоборот.
    </p>
    <p>
      Следующая проблема  - при пересылке из аутлука в аутлук добавляются дополнительные пустые строки tr в таблицу, избавиться от них невозможно. Также при пересылке всегда удаляются условия, как следствие у вас задвоится разметка, и style в head тоже удаляется. Если письмо явно корпоративное, то следует отказаться от условий вообще, и верстать сразу под аутлук, и без style в head.
    </p>
  </section>

  <section id="practice">
    <h2>Обзор сборки</h2>
    <p>Ссылка на сборку - тыц </p>
    <p>Зачем нужна сборка? Нужды, как в случае с сайтами, в ней нет, так как можно обойтись одним файлом. Но использование pug и классов делают верстку гораздо более читаемой на этапе написания, и ускоряет разработку, сравните чистый и аккуратный pug
      <img src="https://i.gyazo.com/eb9bca1959844894614d98238613c039.png" alt="разметка в pug" width="800">
    и html (это все придется писать ручками и копипастить)
      <img src="https://i.gyazo.com/c3f470ec58c7d18fadda4992e6d13e22.png" alt="разметка в html" width="800">
    </p>
    <p>Представленная мною сборка включает в себя базовый шаблон (components/base/layout) и два примера - адаптивная картинка (components/utils/img) и
       адаптивный трех-колоночный футер (components/base/footer). Стили собираются в папке source/css, потом добавляются в тег style и инлайнятся во всех html файлах в папке build. Запуск стандартный - start, в скрипт билда добавлена оптимизация картинок. Структура проекта стандартная, ничего экстраординарного нет. Свои стили можно писать в одном файле - email.scss, письма обычно маленькие, по сравнению со страницей, и смысла разбивать стили на два десятка файлов по десятку строк в каждом я не вижу. Стили из этого файла styleForInline.css будут заинлайнены, а тег style с ними из head будет удален. Если вам нужен адаптив, или какие-то стили, которые не работают инлайново, то их надо писать в emailForStyleTag.scss. Стили из этого файла будут добавленгы в новый тег style. <strong style="color: sandybrown">Тег styleForStyleTag в layout.pug не ошибка!</strong> Это необходимо для работы сборки, в итоговом html файле он будет переименован в нормальный style, для этого используется папка temp, ее содержимое игнориться при коммите.</p>

    <p>Можно использовать классы вместе с заранее прописанными в pug инлайновыми стилями. Галп при сборке дополнит уже имеющиеся инлайновые стилями из styleForInline.css. Если вам надо указать что-то простое, типа паддинга, то сразу инлайново пишите, не придумывайте еще один класс или каскад.</p>

    <p>В сборке есть пример трех-колоночного футера, не ломающегося на адаптиве без медиаправил, на случай удаления style в head, для этого используется следующая схема – внутри td лежат три div с display:inline-block и фиксированной шириной. Ширину можно указывать как в пикселях так и в других величинах. Если ширину не указать явно, то ширина колонки будет съедать все свободное пространство, и мы можем потерять перенос блоков на новую строку на адаптиве. Эту схему можно использовать для любых перестраивающихся блоков, схема простая и рабочая. Но для аутлука разметку надо будет доработать, так как инлайновые блоки он выстроит вертикально, поэтому для него мы создаем внутри td еще одну таблицу и оборачивеам каждый div в td, эти новые части разметки оборачиваем в условия</p>

    <p>Если есть вопросы, предложения, критика - пишите мне в битриксе.</p>
  </section>

  <section id="links">
    <h2>Полезные ссылки</h2>
    <ul>
      <li>
        <a href="https://templates.mailchimp.com/development/">https://templates.mailchimp.com/development/</a> - сборник статей о верстке, в т.ч. писем, есть описания различных приемов
      </li>
      <li>
        <a href="https://templates.mailchimp.com/resources/inline-css/">https://templates.mailchimp.com/resources/inline-css/</a> - инлайнер. Можете верстать письмо с помощью классов, а не инлайновых стилей, а потом заинлайнить все с помощью этого инструмента (реализовано в сборке)
      </li>
      <li><a href="https://www.caniemail.com/">https://www.caniemail.com/</a> - тут можно быстро посмотреть поддержку css-свойств, и многое другое (поддержка шрифтов например).</li>
      <li><a href="https://www.campaignmonitor.com/css/">https://www.campaignmonitor.com/css/</a> - аналог https://www.caniemail.com</li>
      <li><a href="https://backgrounds.cm/">https://backgrounds.cm/</a> - генерация кода с background-image. Внимание! Используются теги VML.</li>
      <li><a href="https://www.hteumeuleu.com/2021/background-properties-in-vml/">https://www.hteumeuleu.com/2021/background-properties-in-vml/</a> - статья про свойства background в VML, за наводку спасибо Насте Яковлевой.</li>
      <li><a href="https://email2go.io/blog/solving-outlook-high-dpi-scaling-issues-in-html-email-templates">https://email2go.io/blog/solving-outlook-high-dpi-scaling-issues-in-html-email-templates</a> - исправление бага с высоким DPI в outlook, за наводку спасибо Насте Яковлевой.</li>
      <li><a href="https://buttons.cm/">https://buttons.cm/</a> - создание кнопок. Внимание! Используются теги VML.</li>
      <li><a href="https://get.foundation/">https://get.foundation/</a> - почтовый фреймворк. Плохо работает с outlook, много багов. Но оттуда можно почерпнуть различные решения.</li>
      <li><a href="https://litmus.com/community/templates">https://litmus.com/community/templates</a> - шаблоны, можно использовать их для поиска решений при верстке.</li>
      <li><a href="https://www.litmus.com/blog">https://www.litmus.com/blog</a> - блог, можно найти интересные статьи, например вот
        <a href="https://www.litmus.com/blog/a-guide-to-bulletproof-buttons-in-email-design/">эту</a> - очень хорошая статья про кнопки, советую.</li>
      <li><a href="https://www.campaignmonitor.com/css/style-element/style-in-head/">https://www.campaignmonitor.com/css/style-element/style-in-head/</a> - поддержка тега style в head. </li>
      <li><a href="https://stackoverflow.design/email/guidelines/getting-started/">https://stackoverflow.design/email/guidelines/getting-started/</a> - подборка статей от stackoverflow</li>
    </ul>
  </section>

  <section class="author">
    <address>
      <p>Олег Ощепков</p>
      <a href="https://github.com/OlegOschepkov">Мой аккаунт на гите</a>
      <a href="https://ligaa.bitrix24.ru/company/personal/user/165/">Я в битриксе</a>
    </address>
  </section>

</div>


<script>hljs.highlightAll();</script>

</body>
</html>
